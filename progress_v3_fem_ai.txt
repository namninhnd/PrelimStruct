# PrelimStruct v3.0 - FEM Analysis & AI Assistant Upgrade
# Progress Tracker
# =============================================================================

## IDEA
Upgrade PrelimStruct from a preliminary design calculator to a comprehensive
finite element modeling platform with AI-assisted automation. Add linear static
FEM analysis using OpenSeesPy and ConcreteProperties, integrate visualization
with opsvis/vfo (Plan, Elevation, 3D views), and implement DeepSeek-powered
AI assistant for automated modeling, optimization, and results interpretation.

--------------------------------------------------------------------------------

## PRD (Product Requirements Document)
- Integrate OpenSeesPy for finite element structural analysis
- Extend ConcreteProperties library with HK Code 2013 design code (layered approach)
  - Reference: https://github.com/robbievanleeuwen/concrete-properties
  - Create HK2013 class extending DesignCode base class
  - Implement HK Code stress-strain profiles as subclasses
- Add FEM visualization (Plan View, Elevation View, 3D View) using opsvis/vfo
- Implement proper core wall modeling with typical tall building configurations:
  - 2 C core walls facing each other
  - 2 C core walls back to back
  - 2 Core walls blended into I section
  - Tube core wall with opening in middle or side of flange
- Allow user input for core wall thickness (default 500mm)
- Generate coupling beams at core wall openings (deep beams with width = wall thickness)
- Implement beam trimming at core wall edges (beams should not overlap with core walls)
- Implement full set of ULS and SLS load combinations per HK Code 2013
- Envelope results across all load combinations (maximum/minimum values, governing load case)
- Implement AI assistant with DeepSeek API for automated modeling
- Add automated mesh generation and model setup
- Implement design optimization with AI guidance
- Add AI-powered results interpretation and recommendations
- Extend report generator with FEM results and AI insights
- Maintain backward compatibility with existing preliminary design features

--------------------------------------------------------------------------------

## FEATURE 8: FEM Foundation Layer (OpenSeesPy + ConcreteProperties)
Status: [ ] Not Started

### Task 8.1: Core Wall Configuration System (Priority Fix)
Status: [ ] Not Started

#### Task 8.1.1: Core Wall Data Models and Enum
Status: [X] Completed
- Define CoreWallConfig enum with all configuration types ✓
- Create CoreWallGeometry data class (dimensions, openings, wall thickness) ✓
- Create CoreWallSectionProperties data class (I, A, centroid, J) ✓
- Update LateralInput with core_wall_config and wall_thickness fields ✓
Files: src/core/data_models.py, tests/test_core_wall_data_models.py
Commit: 8a17826 - All 17 unit tests passing

#### Task 8.1.7: Core Wall Section Properties Calculator (Priority)
Status: [X] Completed
- Implement general section properties calculator ✓
- Calculate Ixx, Iyy, Ixy (product of inertia) ✓
- Calculate torsional constant J ✓
- Calculate shear center location ✓
- Validate against known solutions (textbook examples) ✓
Files: src/fem/section_properties.py, tests/test_section_properties.py
Commit: d3007c7 - All 27 unit tests passing, hand calculations verified

#### Task 8.1.2: I_SECTION Geometry Generator
Status: [X] Completed
- Implement I-section core wall geometry (2 walls blended) ✓
- Calculate flange and web dimensions from user inputs ✓
- Generate coordinate points for section outline ✓
- Calculate section properties (Ixx, Iyy, A, centroid) ✓
- Add unit tests with hand calculation verification ✓
Files: src/fem/core_wall_geometry.py, tests/test_core_wall_geometry.py
Commit: 9613907 - 12 unit tests passing, hand calculations verified

#### Task 8.1.3: TWO_C_FACING Geometry Generator
Status: [X] Not Started
- Implement 2 C-shaped walls facing each other
- Define opening between the two C walls
- Calculate combined section properties
- Handle variable opening width
- Add unit tests
Files: src/fem/core_wall_geometry.py, tests/test_core_wall_geometry.py

#### Task 8.1.4: TWO_C_BACK_TO_BACK Geometry Generator
Status: [X] Completed
- Implement 2 C-shaped walls back to back ✓
- Calculate combined section properties ✓
- Handle connection between walls (optional gap parameter) ✓
- Add unit tests ✓
Files: src/fem/core_wall_geometry.py, tests/test_core_wall_geometry.py
Commit: 80a87e5 - 19 unit tests passing, hand calculations verified

#### Task 8.1.5: TUBE_CENTER_OPENING Geometry Generator
Status: [X] Not Started
- Implement tube/box core wall with center opening
- Define opening dimensions (door/corridor opening)
- Calculate reduced section properties accounting for opening
- Add unit tests
Files: src/fem/core_wall_geometry.py, tests/test_core_wall_geometry.py

#### Task 8.1.6: TUBE_SIDE_OPENING Geometry Generator
Status: [X] Completed
- Implement tube/box core wall with side flange opening ✓
- Define opening location and dimensions ✓
- Calculate asymmetric section properties (including I_xy) ✓
- Add unit tests (14 tests, all passing) ✓
Files: src/fem/core_wall_geometry.py, tests/test_core_wall_geometry.py
Commit: [pending] - All 68 unit tests passing (including 14 for TUBE_SIDE_OPENING)

#### Task 8.1.8: Core Wall UI Integration

Status: [X] Completed
- Add core wall configuration dropdown selector ✓
- Add wall thickness input field (default 500mm) ✓
- Add opening dimensions inputs where applicable ✓
- Display calculated section properties ✓
- Update framing plan to show core wall outline ✓
Files: app.py
Commit: [pending] - UI integration complete, all configurations supported

Implementation Details:
- Added CoreWallConfig dropdown with 5 configuration types (I_SECTION, TWO_C_FACING, TWO_C_BACK_TO_BACK, TUBE_CENTER_OPENING, TUBE_SIDE_OPENING)
- Dynamic input fields based on selected configuration type:
  - I-Section/C-Walls: flange_width, web_length, optional opening_width
  - Tube configurations: length_x, length_y, opening_width, opening_height
- Wall thickness input (200-1000mm, default 500mm)
- Real-time section properties calculation and display in sidebar:
  - Area (m²), Ixx (m⁴), Iyy (m⁴), J (m⁴)
  - Centroid coordinates (m)
  - Product of inertia Ixy for asymmetric sections
- Enhanced framing plan visualization:
  - Detailed core wall outline based on actual geometry
  - Hover tooltip shows configuration type and wall thickness
  - Fallback to simple rectangle for legacy compatibility
- Helper functions added:
  - calculate_core_wall_properties(): Computes section properties
  - get_core_wall_outline(): Generates visualization coordinates
- Updated LateralInput to store core_geometry and section_properties
- All 5 geometry generators integrated (I_SECTION, TWO_C_FACING, TWO_C_BACK_TO_BACK, TUBE_CENTER_OPENING, TUBE_SIDE_OPENING)

### Task 8.1-CB: Coupling Beam System
Status: [X] Completed (Tasks 8.1-CB.1 through 8.1-CB.3)

#### Task 8.1-CB.1: Coupling Beam Data Model
Status: [X] Completed
- Create CouplingBeam data class ✓
- Define properties: span, depth, width (= wall thickness), location ✓
- Add reinforcement fields (top, bottom, diagonal bars, shear links) ✓
- Add CouplingBeamResult data class for design outputs ✓
- Implement span_to_depth_ratio and is_deep_beam properties ✓
Files: src/core/data_models.py
Commit: [pending] - Data models added with full type hints and docstrings

#### Task 8.1-CB.2: Coupling Beam Geometry Generator
Status: [X] Completed
- Detect openings in core wall configurations ✓
- Generate coupling beams spanning openings ✓
- Set beam width equal to wall thickness (deep beam) ✓
- Calculate clear span and support conditions ✓
- Support all 5 core wall configurations:
  - TWO_C_FACING: 1 coupling beam at central opening ✓
  - TWO_C_BACK_TO_BACK: 2 coupling beams (one per opening) ✓
  - TUBE_CENTER_OPENING: 1 coupling beam ✓
  - TUBE_SIDE_OPENING: 1 coupling beam ✓
  - I_SECTION: No coupling beams (no door openings) ✓
- Add calculate_coupling_beam_properties() helper function ✓
Files: src/fem/coupling_beam.py
Commit: [pending] - All 68 unit tests passing

#### Task 8.1-CB.3: Coupling Beam Design (HK Code)
Status: [X] Completed
- Implement coupling beam design per HK Code 2013 ✓
- Calculate required reinforcement for shear and flexure ✓
- Check deep beam provisions where applicable (L/h < 2.0) ✓
- Implement diagonal reinforcement for high shear forces ✓
- Calculate concrete shear capacity (V_c) per HK Code Cl 6.1.2.5 ✓
- Calculate shear reinforcement (V_s) with diagonal bars ✓
- Calculate flexural reinforcement (top and bottom bars) ✓
- Apply minimum reinforcement per HK Code Cl 9.2.1.1 (0.13% bh) ✓
- Generate design summary with calculation audit trail ✓
- Add estimate_coupling_beam_forces() for preliminary force estimation ✓
Files: src/engines/coupling_beam_engine.py
Commit: [pending] - CouplingBeamEngine with full HK Code 2013 compliance

Unit Tests: tests/test_coupling_beam.py
- 24 comprehensive tests covering all functionality
- All tests passing (100% pass rate)
- Test coverage:
  - Data model properties and validation (5 tests)
  - Geometry generation for all configurations (7 tests)
  - Section property calculations (2 tests)
  - Design engine with various load cases (5 tests)
  - Force estimation (2 tests)
  - Integration workflows (2 tests)

Implementation Notes:
- Coupling beams are automatically generated from core wall openings
- Width = wall thickness for compatibility with walls
- Depth constrained by opening height minus clearances
- Deep beam provisions apply when L/h < 2.0 (HK Code Cl 6.7)
- Diagonal reinforcement typically required for high shear forces
- Design includes both shear-dominated and flexure checks
- Calculation audit trail provides full transparency for code checking
- Future enhancement: Task 8.1-CB.4 for visualization integration

#### Task 8.1-CB.4: Coupling Beam Visualization
Status: [X] Completed
- Add coupling beams to framing plan visualization ✓
- Show coupling beam dimensions and labels ✓
- Display reinforcement details in hover/tooltip ✓
Files: app.py (create_framing_grid update)
Commit: [pending] - Coupling beam visualization integrated with Plotly

Implementation Details:
- Added get_coupling_beams() helper function to generate coupling beams from core geometry
- Coupling beams displayed as thick orange lines (#F59E0B, width=8) with markers
- Hover tooltip shows:
  - Clear span (mm)
  - Depth and width (mm)
  - L/h ratio (span-to-depth ratio)
  - Deep beam status (Yes/No for L/h < 2.0)
- Beams positioned at opening locations within core wall
- Supports all 5 core wall configurations:
  - TWO_C_FACING: 1 coupling beam at central opening
  - TWO_C_BACK_TO_BACK: 2 coupling beams (one per opening)
  - TUBE_CENTER_OPENING: 1 coupling beam
  - TUBE_SIDE_OPENING: 1 coupling beam
  - I_SECTION: No coupling beams (no door openings)
- Coordinates converted from mm to m for visualization consistency
- Legend shows "Coupling Beam" entry

### Task 8.2: Beam Trimming at Core Wall Edges (Priority Fix)
Status: [X] Completed

#### Task 8.2.1: Beam-Core Wall Intersection Detection
Status: [X] Completed
- Implement geometric intersection detection in plan view ✓
- Identify which beams cross core wall boundaries ✓
- Calculate intersection points with core wall edges ✓
- Handle beams that pass through vs. terminate at core wall ✓
Files: src/fem/beam_trimmer.py
Commit: [pending] - 24 unit tests passing

#### Task 8.2.2: Beam Trimming Logic
Status: [X] Completed
- Trim beams at external edges of core wall (no overlap) ✓
- Calculate new trimmed beam lengths ✓
- Preserve beam orientation and grid alignment ✓
- Handle partial trimming (beam shortened on one or both ends) ✓
Files: src/fem/beam_trimmer.py
Commit: [pending] - All trimming logic implemented

#### Task 8.2.3: Beam Connection Types at Core Wall
Status: [X] Completed
- Define connection types: MOMENT, PINNED, FIXED ✓
- Assign appropriate connection based on beam type and location ✓
- Update beam end conditions for analysis ✓
- Store connection type in beam data model ✓
Files: src/fem/beam_trimmer.py, src/core/data_models.py
Commit: [pending] - BeamConnectionType enum and assignment logic

#### Task 8.2.4: Update Beam Design After Trimming
Status: [X] Completed
- Recalculate beam loads for trimmed length ✓
- Update moment and shear diagrams ✓
- Re-run beam design with new span ✓
- Preserve original beam properties for comparison ✓
Files: src/fem/beam_trim_updater.py, src/core/data_models.py (BeamResult extended)
Commit: [pending] - BeamTrimUpdater class with full recalculation logic

#### Task 8.2.5: Beam Trimming Visualization
Status: [X] Completed
- Update framing plan to show trimmed beams correctly ✓
- Indicate connection types at core wall (symbol/color) ✓
- Show original vs. trimmed length in hover tooltip ✓
- Add legend for connection types ✓
Files: app.py (create_framing_grid update)
Commit: [pending] - Beam trimming visualization with connection type indicators

Implementation Details:
- Added create_beam_geometries_from_project() helper function to generate BeamGeometry objects
- Beam trimming detection uses BeamTrimmer class for geometric intersection analysis
- Connection type indicators displayed as markers at trimmed beam ends:
  - MOMENT connection: Red diamond (#EF4444) - for beams trimmed at core wall
  - FIXED connection: Purple square (#7C3AED)
  - PINNED connection: Green circle (#10B981) - for regular connections
- Hover tooltip shows:
  - Connection type (MOMENT/PINNED/FIXED)
  - Original beam length (mm)
  - Trimmed beam length (mm)
  - Location (start or end)
- Markers sized at 12px with white outline for visibility
- Coordinates converted from mm to m for consistency
- Works with all 5 core wall configurations
- Graceful error handling (silently skips if trimming fails)
- Legend shows "Beam Connection" entry

Unit Tests: tests/test_beam_trimmer.py
- 24 comprehensive tests covering all functionality
- All tests passing (100% pass rate)
- Test coverage:
  - BeamGeometry properties and calculations (5 tests)
  - Line segment intersection algorithm (3 tests)
  - I-section beam trimming (3 tests)
  - Tube section beam trimming (2 tests)
  - Point-in-polygon algorithm (3 tests)
  - Connection type assignment (2 tests)
  - Helper functions (2 tests)
  - Multiple beam batch processing (1 test)
  - TrimmedBeam dataclass (2 tests)
  - Integration workflow (1 test)

Implementation Notes:
- BeamTrimmer class handles intersection detection and trimming for all core wall configurations
- Supports I_SECTION, TWO_C_FACING, TWO_C_BACK_TO_BACK, TUBE_CENTER_OPENING, TUBE_SIDE_OPENING
- Uses line-segment intersection algorithm for precise geometric detection
- Point-in-polygon ray-casting algorithm determines beam endpoint locations
- Connection types: MOMENT (trimmed at core wall), PINNED (regular connection)
- BeamTrimUpdater recalculates beam design for trimmed spans
- Extended BeamResult dataclass with trimming fields (is_trimmed, original_span, trimmed_span, start_connection, end_connection)
- Calculation audit trail preserved for code checking
- Helper function create_beam_from_grid_points() for convenient beam creation
- Future enhancement: Task 8.2.5 for visualization integration (UI Expert)

### Task 8.3: OpenSeesPy Integration
Status: [ ] Not Started
- Set up OpenSeesPy Python wrapper for structural analysis
- Create abstraction layer for structural engineering use cases
- Implement 2D/3D frame element support (beams, columns)
- Map HK Code concrete grades to OpenSeesPy material models
- Create solver interface for linear static analysis
Files: src/fem/__init__.py, src/fem/fem_engine.py, src/fem/solver.py

### Task 8.4: HK Code 2013 ConcreteProperties Integration
Status: [ ] Not Started
Reference: https://github.com/robbievanleeuwen/concrete-properties
Strategy: Extend ConcreteProperties library with HK Code 2013 design code (layered approach)

#### Task 8.4.1: HK2013 Design Code Class
Status: [ ] Not Started
- Create HK2013 class extending DesignCode base class
- Implement assign_concrete_section() with HK Code validation
- Follow AS3600 implementation pattern as template
- Add HK Code specific docstrings and references
Files: src/fem/design_codes/hk2013.py

#### Task 8.4.2: HK Code Concrete Stress-Strain Profiles
Status: [ ] Not Started
- Create HKConcreteServiceProfile (linear elastic, no tension)
- Create HKConcreteUltimateProfile per HK Code Cl 6.1.2.4
- Implement stress block parameters (alpha, gamma) per HK Code
- Support concrete grades C25, C30, C35, C40, C45, C50, C55, C60
Files: src/fem/design_codes/hk2013.py (stress-strain classes)

#### Task 8.4.3: HK Code Steel Stress-Strain Profiles
Status: [ ] Not Started
- Create HKSteelProfile for fy=500MPa reinforcement
- Create HKShearSteelProfile for fyv=250MPa links
- Implement elastic-plastic with strain hardening option
- Define fracture strain limits per HK Code
Files: src/fem/design_codes/hk2013.py (steel classes)

#### Task 8.4.4: HK Material Factory Methods
Status: [ ] Not Started
- Implement create_concrete_material(compressive_strength)
  - Calculate E per HK Code Cl 3.1.7: E = 3.46 * sqrt(fcu) + 3.21 GPa
  - Calculate flexural tensile strength per HK Code
  - Set density = 24 kN/m3 (or 25 kN/m3 for reinforced)
- Implement create_steel_material(yield_strength, ductility_class)
  - Default fy = 500 MPa, Es = 200 GPa
  - Define ductility classes per HK Code
Files: src/fem/design_codes/hk2013.py

#### Task 8.4.5: HK Code Capacity Reduction Factors
Status: [ ] Not Started
- Implement partial safety factors per HK Code 2013
- Concrete: gamma_c = 1.5 (or 1.25 for accidental)
- Steel: gamma_s = 1.15 (or 1.0 for accidental)
- Implement phi factors for different failure modes
Files: src/fem/design_codes/hk2013.py

#### Task 8.4.6: HK Code Integration Tests
Status: [ ] Not Started
- Test material property calculations against HK Code tables
- Verify stress-strain curves match code requirements
- Test section analysis results against worked examples
- Compare with hand calculations from HK Code Manual
Files: tests/test_hk2013_design_code.py

### Task 8.5: FEM Data Models Extension
Status: [ ] Not Started
- Extend ProjectData with optional fem_model and fem_result fields
- Create FEMModelInput data class (mesh parameters, element types, analysis settings)
- Create FEMResult data class (stress, strain, displacement, reaction forces - enveloped)
- Create LoadCaseResult data class (individual load combination results)
- Create EnvelopedResult data class (maximum/minimum values across all load combinations)
- Create MeshData data class (node coordinates, element connectivity, boundary conditions)
- Define element type enums (beam, plate, solid, coupling_beam)
- Add boundary condition definitions (supports, loads)
- Extend LateralInput with core_wall_config and wall_thickness (default 500mm)
Files: src/core/data_models.py

### Task 8.6: Model Builder (Geometry → FEM Model)
Status: [ ] Not Started
- Convert ProjectData geometry to OpenSeesPy nodes/elements
- Generate beam elements from beam design results (with trimming at core walls)
- Generate column elements from column design results
- Generate core wall elements based on configuration type
- Map column positions to nodes in 3D space
- Apply boundary conditions (fixed supports at base of columns/core walls)
- Apply loads from design engines (gravity loads, wind loads)
- Export to OpenSeesPy model format
Files: src/fem/model_builder.py

### Checkpoint: FEM Schema Freeze
Status: [ ] Not Started
- Lock FEM-related data models before Feature 9
- Confirm downstream consumers (solver, visualization, AI, reports)
- Approve changes via Plan Agent review
Files: src/core/data_models.py

--------------------------------------------------------------------------------


## FEATURE 9: Linear Static Analysis with Load Combinations
Status: [ ] Not Started

### Task 9.1: Load Combination System (ULS & SLS)
Status: [ ] Not Started
- Implement full set of ULS load combinations per HK Code 2013:
  - ULS: 1.4Gk + 1.6Qk (gravity dominant)
  - ULS: 1.0Gk + 1.4Wk (wind dominant)
  - ULS: 1.2Gk + 1.2Qk + 1.2Wk (combined)
  - ULS: 1.4Gk + 1.6Qk + 0.6Wk (gravity + wind)
  - Additional combinations as per HK Code
- Implement full set of SLS load combinations:
  - SLS: 1.0Gk + 1.0Qk (deflection/serviceability)
  - SLS: 1.0Gk + 0.5Qk (frequent load)
  - SLS: 1.0Gk + 0.2Qk (quasi-permanent)
  - Additional SLS combinations as per HK Code
- Create load combination manager
- Apply load combinations to FEM model
Files: src/fem/load_combinations.py, src/core/data_models.py (extend LoadCombination enum)

### Task 9.2: Solver Implementation
Status: [ ] Not Started
- Implement linear static solver wrapper for OpenSeesPy
- Solve: [K]{u} = {F} for displacements for each load combination
- Calculate element stresses and strains from displacements
- Extract reaction forces at supports
- Post-process results (max stress, max deflection, utilization ratios)
Files: src/fem/solver.py

### Task 9.3: Result Enveloping
Status: [ ] Not Started
- Envelope results across all load combinations:
  - Maximum and minimum stresses for each element
  - Maximum and minimum deflections
  - Maximum and minimum reaction forces
  - Critical load combination identification
- Generate enveloped results for design checks
- Display both individual and enveloped results
Files: src/fem/results_processor.py (enveloping functions)

### Task 9.4: Results Processing
Status: [ ] Not Started
- Process raw OpenSeesPy solver output
- Calculate utilization ratios (stress / allowable stress)
- Identify critical elements (high stress, large deflection)
- Generate stress contour data for visualization
- Calculate deflected shape coordinates
- Compare FEM results vs. simplified design calculations
- Generate summary statistics (max/min values, critical locations)
Files: src/fem/results_processor.py

### Task 9.5: Integration with Design Engines
Status: [ ] Not Started
- Compare FEM beam results (enveloped) with simplified beam design
- Compare FEM column results (enveloped) with simplified column design
- Compare FEM core wall results with simplified core wall design
- Flag discrepancies between FEM and simplified methods
- Validate simplified design assumptions using FEM
- Generate comparison reports showing governing load cases
Files: src/fem/results_processor.py (comparison functions)

--------------------------------------------------------------------------------

## FEATURE 10: FEM Visualization (opsvis/vfo Integration)
Status: [ ] Not Started

### Task 10.0: Visualization Spike (opsvis/vfo Validation)
Status: [ ] Not Started
- Build minimal OpenSeesPy model in sandbox module
- Extract nodes/elements via opsvis/vfo
- Render basic Plotly plan view
- Confirm data extraction performance and API stability
Files: src/fem/visualization_spike.py

### Task 10.1: Visualization Infrastructure

Status: [ ] Not Started
- Integrate opsvis or vfo (Visualization For OpenSees) library
- Create visualization wrapper module
- Set up visualization data extraction from OpenSeesPy model
- Create visualization configuration data structures
Files: src/fem/visualization.py

### Task 10.2: Plan View Visualization
Status: [ ] Not Started
- Create top-down plan view of structure
- Display beam/column layout in plan
- Show element labels and dimensions
- Display stress contours (color-coded by utilization)
- Show load application points
- Add interactive element selection
Files: src/fem/visualization.py (create_plan_view), app.py (Plan View tab)

### Task 10.3: Elevation View Visualization
Status: [ ] Not Started
- Create side elevation view showing building height
- Display multi-story structure with floor levels
- Show column continuity through floors
- Display deflected shape (exaggerated for visibility)
- Show reaction forces at supports
- Add floor-by-floor stress visualization
Files: src/fem/visualization.py (create_elevation_view), app.py (Elevation View tab)

### Task 10.4: 3D View Visualization
Status: [ ] Not Started
- Create isometric 3D view of structure
- Enable rotation, zoom, and pan controls
- Display stress contours on 3D elements
- Show deflected shape overlay in 3D
- Display reaction forces as vectors
- Add element selection for detailed results
- Export 3D visualization images for reports
Files: src/fem/visualization.py (create_3d_view), app.py (3D View tab)

### Task 10.5: Visualization Integration in Dashboard
Status: [ ] Not Started
- Add "FEM Analysis" section to Streamlit dashboard
- Create tabs for Plan View, Elevation View, 3D View
- Add "Run FEM Analysis" button
- Display analysis progress and status
- Show FEM vs. Simplified comparison side-by-side
- Add export functionality for visualization images
Files: app.py (FEM Analysis section)

--------------------------------------------------------------------------------

## FEATURE 11: AI Assistant - Core Infrastructure (DeepSeek)
Status: [ ] Not Started

### Task 11.1: DeepSeek API Integration
Status: [ ] Not Started
- Create DeepSeek API client wrapper
- Implement API authentication and configuration
- Add error handling and retry logic
- Implement response parsing and validation
- Add caching for common queries
- Create abstraction layer for future multi-provider support
Files: src/ai/__init__.py, src/ai/llm_service.py

### Task 11.2: Prompt Engineering
Status: [ ] Not Started
- Design system prompts for Senior Structural Engineer role
- Create prompt templates for:
  - Design review and recommendations
  - Results interpretation
  - Model setup guidance
  - Optimization suggestions
  - Mesh generation recommendations
- Set response length constraints (150-300 words)
- Add context injection from ProjectData
Files: src/ai/prompts.py

### Task 11.3: AI Assistant UI Components
Status: [ ] Not Started
- Create chat interface in Streamlit dashboard
- Add "Ask AI" button and chat panel
- Display AI recommendations in real-time
- Add context-aware suggestions (based on current design state)
- Implement conversation history
- Add loading states and error messages
Files: app.py (AI Assistant section)

### Task 11.4: Structured Response Parsing
Status: [ ] Not Started
- Request structured JSON output from DeepSeek
- Parse efficiency_score, risks, suggestions, carbon_comment
- Validate response structure using Pydantic
- Enable programmatic handling of AI responses
- Add fallback for unstructured responses
Files: src/ai/llm_service.py (response parsing)

--------------------------------------------------------------------------------

## FEATURE 12: AI-Assisted Mesh Generation & Model Setup
Status: [ ] Not Started

### Task 12.1: Automated Mesh Generation
Status: [ ] Not Started
- Implement rule-based mesh generation:
  - Automatic element sizing based on geometry
  - Refinement at stress concentrations (columns, supports)
  - Mesh quality checks (aspect ratio, skewness)
- Generate mesh from ProjectData automatically
- Validate mesh quality before analysis
- Add mesh refinement options
Files: src/ai/mesh_generator.py

### Task 12.2: ML Mesh Density Prediction (Optional Enhancement)
Status: [ ] Not Started
- Create ML model for optimal mesh density prediction
- Train on geometry → mesh quality dataset
- Predict required mesh density for accuracy
- Integrate with rule-based mesh generation
Files: src/ai/mesh_ml.py

### Task 12.3: Smart Model Setup
Status: [ ] Not Started
- Automatically infer boundary conditions from geometry
- Suggest load application points based on design loads
- Auto-detect support locations (base of columns)
- Apply material properties from ProjectData using ConcreteProperties
- Generate load combinations automatically
- Validate model setup before solving
- Use AI (DeepSeek) to suggest model setup improvements
Files: src/ai/auto_setup.py

--------------------------------------------------------------------------------

## FEATURE 13: AI-Assisted Design Optimization
Status: [ ] Not Started

### Task 13.1: Design Optimization Engine
Status: [ ] Not Started
- Implement gradient-based optimization for element sizing
- Multi-objective optimization (cost, weight, deflection)
- Constraint handling (stress limits, deflection limits)
- Integration with OpenSeesPy solver for iterative optimization
- Generate optimization reports
Files: src/ai/optimizer.py

### Task 13.2: AI-Guided Optimization
Status: [ ] Not Started
- Use DeepSeek LLM to suggest optimization strategies
- Interpret optimization results using AI
- Provide design alternatives with trade-offs
- Explain optimization recommendations
- Generate natural language optimization summaries
Files: src/ai/optimizer.py (AI integration), src/ai/llm_service.py (optimization prompts)

--------------------------------------------------------------------------------

## FEATURE 14: AI Results Interpretation & Recommendations
Status: [ ] Not Started

### Task 14.1: AI Results Interpreter
Status: [ ] Not Started
- Analyze FEM results using DeepSeek LLM
- Identify critical areas (high stress, large deflection)
- Compare FEM results with simplified design
- Flag discrepancies or concerns
- Suggest design improvements
- Generate natural language summary of analysis
Files: src/ai/results_interpreter.py

### Task 14.2: Integration with Report Generator
Status: [ ] Not Started
- Add FEM results section to HTML report
- Include AI-generated interpretation in report
- Add FEM visualizations (Plan, Elevation, 3D) to report
- Compare simplified vs. FEM results in report
- Include optimization recommendations in report
- Add AI design review with FEM insights
Files: src/report/report_generator.py (FEM sections)

--------------------------------------------------------------------------------

## FEATURE 15: Testing & Validation
Status: [ ] Not Started

### Task 15.1: FEM Engine Tests
Status: [ ] Not Started
- Test OpenSeesPy model generation from ProjectData
- Test ConcreteProperties material mapping
- Test boundary condition application
- Verify load application
- Test solver accuracy against known solutions
Files: tests/test_fem_engine.py, tests/test_fem_solver.py

### Task 15.2: Model Builder Tests
Status: [ ] Not Started
- Test geometry to FEM model conversion
- Test beam/column element generation
- Test boundary condition inference
- Test load application from design engines
Files: tests/test_model_builder.py

### Task 15.3: Visualization Tests
Status: [ ] Not Started
- Test Plan View generation
- Test Elevation View generation
- Test 3D View generation
- Test stress contour rendering
- Test deflected shape visualization
Files: tests/test_fem_visualization.py

### Task 15.4: AI Assistant Tests
Status: [ ] Not Started
- Test DeepSeek API integration
- Test prompt template generation
- Test response parsing and validation
- Test mesh generation quality
- Test optimization convergence
- Test results interpretation accuracy
Files: tests/test_ai_service.py, tests/test_mesh_generator.py, tests/test_optimizer.py

### Task 15.5: Integration Tests
Status: [ ] Not Started
- End-to-end test: ProjectData → FEM Model → Analysis → Results → Visualization
- Test AI assistant workflow (model setup → analysis → interpretation)
- Test optimization workflow
- Performance benchmarks (model generation time, solve time, AI response time)
Files: tests/test_fem_integration.py

================================================================================
# IMPLEMENTATION PHASES (v3.0)
================================================================================

## PHASE 1: FEM Core (Features 8-10) - Foundation
Milestone: Working FEM analysis with visualization
- Feature 8: FEM Foundation Layer (OpenSeesPy + ConcreteProperties)
  - Task 8.1: Core Wall Configuration System (13 subtasks)
  - Task 8.1-CB: Coupling Beam System (4 subtasks)
  - Task 8.2: Beam Trimming (5 subtasks)
  - Task 8.3: OpenSeesPy Integration
  - Task 8.4: HK Code 2013 ConcreteProperties Integration (6 subtasks)
  - Task 8.5: FEM Data Models Extension
  - Task 8.6: Model Builder
- Feature 9: Linear Static Analysis (5 tasks)
- Feature 10: FEM Visualization (5 tasks)

## PHASE 2: AI Assistant Basic (Feature 11) - After FEM Stable
Milestone: AI can interpret FEM results and provide recommendations
- Feature 11: AI Assistant Core Infrastructure
  - Task 11.1: DeepSeek API Integration
  - Task 11.2: Prompt Engineering
  - Task 11.3: AI Assistant UI Components
  - Task 11.4: Structured Response Parsing

## PHASE 3: AI Automation (Features 12-14) - After AI Basics Work
Milestone: AI-assisted modeling and optimization
- Feature 12: AI-Assisted Mesh Generation
- Feature 13: AI-Assisted Design Optimization
- Feature 14: AI Results Interpretation & Recommendations

## PHASE 4: Comprehensive Testing (Feature 15) - Continuous
- Feature 15: Testing & Validation (run throughout all phases)

================================================================================
# CURRENT FOCUS: Phase 1 - Feature 8 - FEM Foundation Layer
# NEXT ACTION: Task 8.1.1 - Core Wall Data Models and Enum
#              Task 8.4.1 - HK2013 Design Code Class (can run in parallel)
#
# AGENT ASSIGNMENTS (Balanced Team)
# - Task 8.1.1 → Coder Agent
# - Task 8.1.7 → Coder Agent
# - Task 8.1.2 → Coder Agent
# - Task 8.1.3 → Coder Agent
# - Task 8.1.4 → Coder Agent
# - Task 8.1.5 → Coder Agent
# - Task 8.1.6 → Coder Agent
# - Task 8.1.8 → UI Expert Agent
# - Task 8.1-CB.1–8.1-CB.3 → Coder Agent
# - Task 8.1-CB.4 → UI Expert Agent
# - Task 8.2.1–8.2.4 → Coder Agent
# - Task 8.2.5 → UI Expert Agent
# - Task 8.3 → Coder Agent
# - Task 8.4.1–8.4.6 → Coder Agent
# - Task 8.5 → Coder Agent
# - Task 8.6 → Coder Agent
# - Task 9.1–9.5 → Coder Agent
# - Task 10.0–10.4 → UI Expert Agent (Coder support for data extraction)
# - Task 10.5 → UI Expert Agent
# - Task 11.1–11.4 → Coder Agent
# - Task 12.1–12.3 → Coder Agent
# - Task 13.1–13.2 → Coder Agent
# - Task 14.1–14.2 → Coder Agent
# - Feature 15 tests → Test Agent
# - After any commit → Code Reviewer Agent
# - Phase transitions / architecture checks → Plan Agent
#
# COMPLETED (v2.1):

# - Feature 1 - Python Engineering Core (All 5 Tasks)
# - Feature 2 - Lateral Stability Module (All 4 Tasks)
# - Feature 3 - Streamlit Dashboard (All 6 Tasks)
# - Feature 4 - Magazine-Style Report Generator (All 5 Tasks)
# - Feature 5 - Debug & Integration Testing (All 4 Tasks)
#
# TASK COUNT (v3.0):
# - Feature 8: 6 main tasks, 28 subtasks
# - Feature 9: 5 tasks
# - Feature 10: 5 tasks
# - Feature 11: 4 tasks
# - Feature 12: 3 tasks
# - Feature 13: 2 tasks
# - Feature 14: 2 tasks
# - Feature 15: 5 tasks
# - TOTAL: 32 main tasks + 28 subtasks = 60 work items
================================================================================
