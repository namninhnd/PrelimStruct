# PrelimStruct CI/CD Pipeline
# Runs automated tests on push to main and pull requests

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install test dependencies
          pip install pytest-cov pytest-xdist
      
      - name: Run tests with coverage
        id: pytest
        run: |
          pytest tests/ -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -n auto \
            --junitxml=test-results.xml
      
      - name: Check coverage threshold (informational)
        if: always() && steps.pytest.outcome == 'success'
        run: |
          # Extract coverage percentage from XML report
          COVERAGE=$(python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.get('line-rate', 0))
          print(f'{line_rate * 100:.1f}')
          ")
          echo "Coverage: ${COVERAGE}%"
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          
          # Check against 80% threshold (informational only)
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "::warning::Coverage ${COVERAGE}% is below 80% target"
            echo "## âš ï¸ Coverage Below Target" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Current: **${COVERAGE}%** | Target: **80%**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Coverage Meets Target" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Current: **${COVERAGE}%** | Target: **80%**" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload coverage report (XML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-xml-py${{ matrix.python-version }}
          path: coverage.xml
          retention-days: 30
      
      - name: Upload coverage report (HTML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-html-py${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 30
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-py${{ matrix.python-version }}
          path: test-results.xml
          retention-days: 30
      
      - name: Display coverage summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage HTML report: \`coverage-html-py${{ matrix.python-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage XML report: \`coverage-xml-py${{ matrix.python-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test results: \`test-results-py${{ matrix.python-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Badge URL:** \`https://github.com/${{ github.repository }}/actions/workflows/ci.yml/badge.svg\`" >> $GITHUB_STEP_SUMMARY
